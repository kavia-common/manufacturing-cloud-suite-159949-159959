{"is_source_file": true, "format": "Python", "description": "This file defines the BroadcastManager class responsible for managing WebSocket connections and broadcasting messages related to KPIs and scheduler events within a real-time manufacturing API. It includes methods for subscribing/unsubscribing WebSocket clients to topics, broadcasting messages, and publishing specific event types, serving as an in-process pub-sub system for real-time updates.", "external_files": ["starlette.websockets", "src.schemas.realtime"], "external_methods": ["WebSocket.send_json", "KpiSnapshot.model_dump", "SchedulerEvent.model_dump", "WsEnvelope.model_dump"], "published": ["broadcast_manager"], "classes": [{"name": "BroadcastManager", "description": "Manages WebSocket subscriptions and broadcasting messages for real-time updates in the manufacturing API."}], "methods": [{"name": "None __init__(self)", "description": "Initializes the BroadcastManager with topic and lock dictionaries, and a global lock.", "scope": "BroadcastManager", "scopeKind": "class"}, {"name": "asyncio.Lock _topic_lock(self, topic: str)", "description": "Retrieves or creates an asyncio.Lock for a specific topic.", "scope": "BroadcastManager", "scopeKind": "class"}, {"name": "str dashboard_topic(self, tenant_id: UUID | str)", "description": "Generates the topic string for dashboard updates for a given tenant.", "scope": "BroadcastManager", "scopeKind": "class"}, {"name": "str scheduler_topic(self, tenant_id: UUID | str, board: Optional[str] = None)", "description": "Generates the topic string for scheduler updates for a tenant and optional board.", "scope": "BroadcastManager", "scopeKind": "class"}, {"name": "None _ensure_topic(self, topic: str)", "description": "Ensures that a topic exists in the _topics dictionary, creating it if necessary.", "scope": "BroadcastManager", "scopeKind": "class"}, {"name": "None connect(self, topic: str, websocket: WebSocket)", "description": "Adds a WebSocket connection to a specified topic's subscriber set.", "scope": "BroadcastManager", "scopeKind": "class"}, {"name": "None disconnect(self, topic: str, websocket: WebSocket)", "description": "Removes a WebSocket connection from a specified topic.", "scope": "BroadcastManager", "scopeKind": "class"}, {"name": "None broadcast(self, topic: str, message: dict, exclude: Optional[WebSocket] = None)", "description": "Sends a message to all WebSocket subscribers of a topic, handling disconnects and errors.", "scope": "BroadcastManager", "scopeKind": "class"}, {"name": "None publish_kpi_snapshot(self, tenant_id: UUID | str, snapshot: KpiSnapshot)", "description": "Publishes a KPI snapshot to the dashboard topic for a tenant.", "scope": "BroadcastManager", "scopeKind": "class"}, {"name": "None publish_scheduler_event(self, tenant_id: UUID | str, event: SchedulerEvent)", "description": "Publishes a scheduler event to the appropriate scheduler topic for a tenant.", "scope": "BroadcastManager", "scopeKind": "class"}], "calls": ["self._ensure_topic", "self._topic_lock", "ws.send_json", "snapshot.model_dump", "event.model_dump", "env.model_dump", "self.broadcast"], "search-terms": ["WebSocket subscription", "Kafka-like pub-sub", "asyncio WebSocket management", "real-time KPI broadcasting", "scheduling event publishing", "in-process pub-sub system"], "state": 2, "file_id": 58, "knowledge_revision": 155, "git_revision": "d274571abc5df5a6a7e6a000b418bfffb7011d0b", "revision_history": [{"142": ""}, {"155": "d274571abc5df5a6a7e6a000b418bfffb7011d0b"}], "ctags": [{"_type": "tag", "name": "BroadcastManager", "path": "/home/kavia/workspace/code-generation/manufacturing-cloud-suite-159949-159959/manufacturing_api/src/services/realtime.py", "pattern": "/^class BroadcastManager:$/", "language": "Python", "kind": "class"}, {"_type": "tag", "name": "__init__", "path": "/home/kavia/workspace/code-generation/manufacturing-cloud-suite-159949-159959/manufacturing_api/src/services/realtime.py", "pattern": "/^    def __init__(self) -> None:$/", "language": "Python", "typeref": "typename:None", "kind": "member", "signature": "(self)", "scope": "BroadcastManager", "scopeKind": "class"}, {"_type": "tag", "name": "_ensure_topic", "path": "/home/kavia/workspace/code-generation/manufacturing-cloud-suite-159949-159959/manufacturing_api/src/services/realtime.py", "pattern": "/^    async def _ensure_topic(self, topic: str) -> None:$/", "language": "Python", "typeref": "typename:None", "kind": "member", "signature": "(self, topic: str)", "scope": "BroadcastManager", "scopeKind": "class"}, {"_type": "tag", "name": "_topic_lock", "path": "/home/kavia/workspace/code-generation/manufacturing-cloud-suite-159949-159959/manufacturing_api/src/services/realtime.py", "pattern": "/^    def _topic_lock(self, topic: str) -> asyncio.Lock:$/", "language": "Python", "typeref": "typename:asyncio.Lock", "kind": "member", "signature": "(self, topic: str)", "scope": "BroadcastManager", "scopeKind": "class"}, {"_type": "tag", "name": "broadcast", "path": "/home/kavia/workspace/code-generation/manufacturing-cloud-suite-159949-159959/manufacturing_api/src/services/realtime.py", "pattern": "/^    async def broadcast(self, topic: str, message: dict, exclude: Optional[WebSocket] = None) ->/", "language": "Python", "typeref": "typename:None", "kind": "member", "signature": "(self, topic: str, message: dict, exclude: Optional[WebSocket] = None)", "scope": "BroadcastManager", "scopeKind": "class"}, {"_type": "tag", "name": "broadcast_manager", "path": "/home/kavia/workspace/code-generation/manufacturing-cloud-suite-159949-159959/manufacturing_api/src/services/realtime.py", "pattern": "/^broadcast_manager = BroadcastManager()$/", "language": "Python", "kind": "variable"}, {"_type": "tag", "name": "connect", "path": "/home/kavia/workspace/code-generation/manufacturing-cloud-suite-159949-159959/manufacturing_api/src/services/realtime.py", "pattern": "/^    async def connect(self, topic: str, websocket: WebSocket) -> None:$/", "language": "Python", "typeref": "typename:None", "kind": "member", "signature": "(self, topic: str, websocket: WebSocket)", "scope": "BroadcastManager", "scopeKind": "class"}, {"_type": "tag", "name": "dashboard_topic", "path": "/home/kavia/workspace/code-generation/manufacturing-cloud-suite-159949-159959/manufacturing_api/src/services/realtime.py", "pattern": "/^    def dashboard_topic(self, tenant_id: UUID | str) -> str:$/", "language": "Python", "typeref": "typename:str", "kind": "member", "signature": "(self, tenant_id: UUID | str)", "scope": "BroadcastManager", "scopeKind": "class"}, {"_type": "tag", "name": "disconnect", "path": "/home/kavia/workspace/code-generation/manufacturing-cloud-suite-159949-159959/manufacturing_api/src/services/realtime.py", "pattern": "/^    async def disconnect(self, topic: str, websocket: WebSocket) -> None:$/", "language": "Python", "typeref": "typename:None", "kind": "member", "signature": "(self, topic: str, websocket: WebSocket)", "scope": "BroadcastManager", "scopeKind": "class"}, {"_type": "tag", "name": "logger", "path": "/home/kavia/workspace/code-generation/manufacturing-cloud-suite-159949-159959/manufacturing_api/src/services/realtime.py", "pattern": "/^logger = logging.getLogger(__name__)$/", "language": "Python", "kind": "variable"}, {"_type": "tag", "name": "publish_kpi_snapshot", "path": "/home/kavia/workspace/code-generation/manufacturing-cloud-suite-159949-159959/manufacturing_api/src/services/realtime.py", "pattern": "/^    async def publish_kpi_snapshot(self, tenant_id: UUID | str, snapshot: KpiSnapshot) -> None:$/", "language": "Python", "typeref": "typename:None", "kind": "member", "signature": "(self, tenant_id: UUID | str, snapshot: KpiSnapshot)", "scope": "BroadcastManager", "scopeKind": "class"}, {"_type": "tag", "name": "publish_scheduler_event", "path": "/home/kavia/workspace/code-generation/manufacturing-cloud-suite-159949-159959/manufacturing_api/src/services/realtime.py", "pattern": "/^    async def publish_scheduler_event(self, tenant_id: UUID | str, event: SchedulerEvent) -> Non/", "language": "Python", "typeref": "typename:None", "kind": "member", "signature": "(self, tenant_id: UUID | str, event: SchedulerEvent)", "scope": "BroadcastManager", "scopeKind": "class"}, {"_type": "tag", "name": "scheduler_topic", "path": "/home/kavia/workspace/code-generation/manufacturing-cloud-suite-159949-159959/manufacturing_api/src/services/realtime.py", "pattern": "/^    def scheduler_topic(self, tenant_id: UUID | str, board: Optional[str] = None) -> str:$/", "language": "Python", "typeref": "typename:str", "kind": "member", "signature": "(self, tenant_id: UUID | str, board: Optional[str] = None)", "scope": "BroadcastManager", "scopeKind": "class"}], "hash": "11906a311f4f9a1b610bec68fc9958ac", "format-version": 4, "code-base-name": "manufacturing_api", "filename": "manufacturing_api/src/services/realtime.py", "fields": [{"name": "broadcast_manager = BroadcastManager()", "scope": "", "scopeKind": "", "description": "unavailable"}, {"name": "logger = logging.getLogger(__name__)", "scope": "", "scopeKind": "", "description": "unavailable"}]}