{"is_source_file": true, "format": "Python", "description": "This file implements authentication and tenant context management for a FastAPI-based application. It includes dependencies for extracting tenant IDs from headers, managing database sessions scoped to tenants, decoding JWT tokens, and retrieving user information with role-based authorization.", "external_files": ["src.core.security", "src.db.session", "src.repositories.security"], "external_methods": ["decode_token", "get_async_session", "tenant_context", "SecurityRepository.get_user_by_id", "SecurityRepository.list_roles_for_user"], "published": ["get_tenant_id", "get_tenant_session", "get_session_no_tenant", "get_current_user", "get_current_active_user", "require_roles"], "classes": [], "methods": [{"name": "UUID get_tenant_id(x_tenant_id: str | None = Header(default=None, alias=\"X-Tenant-ID\"))", "description": "Extracts and validates the tenant ID from the 'X-Tenant-ID' header, raising an HTTP exception if missing or invalid.", "scope": "", "scopeKind": ""}, {"name": "AsyncGenerator[AsyncSession,None] get_tenant_session( tenant_id: UUID = Depends(get_tenant_id), session_dep=Depends(get_async_session), )", "description": "Provides a database session with tenant context activated, ensuring RLS policies apply to tenant-specific data.", "scope": "", "scopeKind": ""}, {"name": "AsyncGenerator[AsyncSession,None] get_session_no_tenant( session_dep=Depends(get_async_session), )", "description": "Provides a database session without tenant context, suitable for system-level or internal operations.", "scope": "", "scopeKind": ""}, {"name": "get_current_user( tenant_id: UUID = Depends(get_tenant_id), token: str = Depends(oauth2_scheme), session: AsyncSession = Depends(get_tenant_session), )", "description": "Authenticates the user based on a Bearer token, verifies tenant matching, and loads the user entity within an RLS-enabled session.", "scope": "", "scopeKind": ""}, {"name": "get_current_active_user(user=Depends(get_current_user))", "description": "Ensures the current user is active before returning the user object.", "scope": "", "scopeKind": ""}, {"name": "require_roles(*required: str)", "description": "Creates a dependency that enforces user role or permission checks for access control.", "scope": "", "scopeKind": ""}, {"name": "_dep(user=Depends(get_current_active_user), session: AsyncSession = Depends(get_tenant_session))", "scope": "require_roles", "scopeKind": "function", "description": "unavailable"}], "calls": ["decode_token", "get_async_session", "tenant_context", "SecurityRepository(session).get_user_by_id", "SecurityRepository(session).list_roles_for_user"], "search-terms": ["OAuth2PasswordBearer", "tenant_id header", "async session", "decode_token", "JWTError", "RBAC", "tenant context", "RLS", "user authentication", "FastAPI dependencies"], "state": 2, "file_id": 26, "knowledge_revision": 96, "git_revision": "06068ff228e7e597e70061c7ebfce1a73fe861df", "revision_history": [{"59": ""}, {"95": "06068ff228e7e597e70061c7ebfce1a73fe861df"}, {"96": "06068ff228e7e597e70061c7ebfce1a73fe861df"}], "ctags": [{"_type": "tag", "name": "_dep", "path": "/home/kavia/workspace/code-generation/manufacturing-cloud-suite-159949-159959/manufacturing_api/src/core/deps.py", "pattern": "/^    async def _dep(user=Depends(get_current_active_user), session: AsyncSession = Depends(get_te/", "file": true, "language": "Python", "kind": "function", "signature": "(user=Depends(get_current_active_user), session: AsyncSession = Depends(get_tenant_session))", "scope": "require_roles", "scopeKind": "function"}, {"_type": "tag", "name": "get_current_active_user", "path": "/home/kavia/workspace/code-generation/manufacturing-cloud-suite-159949-159959/manufacturing_api/src/core/deps.py", "pattern": "/^async def get_current_active_user(user=Depends(get_current_user)):$/", "language": "Python", "kind": "function", "signature": "(user=Depends(get_current_user))"}, {"_type": "tag", "name": "get_current_user", "path": "/home/kavia/workspace/code-generation/manufacturing-cloud-suite-159949-159959/manufacturing_api/src/core/deps.py", "pattern": "/^async def get_current_user($/", "language": "Python", "kind": "function", "signature": "( tenant_id: UUID = Depends(get_tenant_id), token: str = Depends(oauth2_scheme), session: AsyncSession = Depends(get_tenant_session), )"}, {"_type": "tag", "name": "get_session_no_tenant", "path": "/home/kavia/workspace/code-generation/manufacturing-cloud-suite-159949-159959/manufacturing_api/src/core/deps.py", "pattern": "/^async def get_session_no_tenant($/", "language": "Python", "typeref": "typename:AsyncGenerator[AsyncSession,None]", "kind": "function", "signature": "( session_dep=Depends(get_async_session), )"}, {"_type": "tag", "name": "get_tenant_id", "path": "/home/kavia/workspace/code-generation/manufacturing-cloud-suite-159949-159959/manufacturing_api/src/core/deps.py", "pattern": "/^async def get_tenant_id(x_tenant_id: str | None = Header(default=None, alias=\"X-Tenant-ID\")) -> /", "language": "Python", "typeref": "typename:UUID", "kind": "function", "signature": "(x_tenant_id: str | None = Header(default=None, alias=\"X-Tenant-ID\"))"}, {"_type": "tag", "name": "get_tenant_session", "path": "/home/kavia/workspace/code-generation/manufacturing-cloud-suite-159949-159959/manufacturing_api/src/core/deps.py", "pattern": "/^async def get_tenant_session($/", "language": "Python", "typeref": "typename:AsyncGenerator[AsyncSession,None]", "kind": "function", "signature": "( tenant_id: UUID = Depends(get_tenant_id), session_dep=Depends(get_async_session), )"}, {"_type": "tag", "name": "logger", "path": "/home/kavia/workspace/code-generation/manufacturing-cloud-suite-159949-159959/manufacturing_api/src/core/deps.py", "pattern": "/^logger = logging.getLogger(__name__)$/", "language": "Python", "kind": "variable"}, {"_type": "tag", "name": "oauth2_scheme", "path": "/home/kavia/workspace/code-generation/manufacturing-cloud-suite-159949-159959/manufacturing_api/src/core/deps.py", "pattern": "/^oauth2_scheme = OAuth2PasswordBearer(tokenUrl=\"\\/auth\\/login\")$/", "language": "Python", "kind": "variable"}, {"_type": "tag", "name": "require_roles", "path": "/home/kavia/workspace/code-generation/manufacturing-cloud-suite-159949-159959/manufacturing_api/src/core/deps.py", "pattern": "/^def require_roles(*required: str):$/", "language": "Python", "kind": "function", "signature": "(*required: str)"}], "hash": "e6c80bfeaa5f7aac6a79e3c7c64eab45", "format-version": 4, "code-base-name": "manufacturing_api", "filename": "manufacturing_api/src/core/deps.py", "fields": [{"name": "logger = logging.getLogger(__name__)", "scope": "", "scopeKind": "", "description": "unavailable"}, {"name": "oauth2_scheme = OAuth2PasswordBearer(tokenUrl=\"\\/auth\\/login\")", "scope": "", "scopeKind": "", "description": "unavailable"}]}